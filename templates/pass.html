<script>

    // helper functions
    function getParentIdFromId(id) {
        return id.split('-').pop();
    }
    
    function getRowElem(parent_id, name){
        return $('#' + name + '-' + parent_id);
    }

    function getName(parent_id) {
        return getRowElem(parent_id, 'name').html();
    }

    function updateElem(elem_id, elem_name, success_callback) {
        elem = $('#' + elem_id);
        var val = elem.val();

        var parent_id = getParentIdFromId(elem_id);
        var name = getName(parent_id);

        showAlert('info', 'Updating ' + elem_name + ' for ' + name);
        elem.prop('disabled', 'disabled');

        var data = {
            parent_id: parent_id
        };

        data[elem_name] = val;

        if (elem_name == 'cellphone') {
            var van_id = $('#vanid-' + parent_id).html();
            data[van_id] = van_id
        }

        $.ajax({
            type: 'POST', 
            url: '/consolidated/{{location.locationname[0:3]}}/{{active_tab}}/pass',
            data: data
        }).done(function(res){
            showAlert('success', elem_name + ' for ' + name + ' has been added');
            elem.prop('disabled', false);

            if (success_callback) {
                success_callback(parent_id, res, elem);
            }
        }).fail(function(res){
            var message = elem_name + ' for ' + name + ' has NOT been added';
            if (res.message) {
                message += 'Error message: ' + res.message
            }

            showAlert('error', message);
            elem.prop('disabled', false);
        });
    }

    // success callbacks
    function updateNote(parent_id, res, elem) {
        var child = document.createElement('td');
        child.innerText = res;
        getRowElem(parent_id, 'row').append(child);
        elem.val('');
    }

    function updateGoalActual(parent_id, res, elem) {
        getRowElem(parent_id, 'perc').html(getRowElem(parent_id, 'actual').val() / getRowElem(parent_id, 'goal').val());
    }

    function updateCheckIns(parent_id, res, elem) {
        console.log(res);
        
        getRowElem(parent_id, 'departure').html(res.departure);
        getRowElem(parent_id, 'next-check').html(res.check_in_time);
        getRowElem(parent_id, 'last-check').html(res.last_check_in);
        getRowElem(parent_id, 'check_ins').html(res.check_ins);
    }

    function setReturned(parent_id, res, elem) {
        getRowElem(parent_id, 'next-check').html('');
        getRowElem(parent_id, 'last-check').html(res.last_check_in);
        getRowElem(parent_id, 'check_ins').html(res.check_ins);
    }

    // enter handler
    $('body').on('keyup', function(e) {
        e.preventDefault();

        if (e.keyCode == 13) {
            var name = e.target.attributes['name'].nodeValue;
            var id = event.target.id;

            if (name == 'note') {
                updateElem(id, name, updateNote);
            } else if (name == 'cellphone') {
                updateElem(id, name, null);
            } else if (name == 'actual') {
                updateElem(id, name, updateGoalActual);
            } else if (name == 'goal') {
                updateElem(id, name, updateGoalActual);
            } else if (name == 'packets_given') {
                updateElem(id, name, null);
            } else if (name == 'packet_names') {
                updateElem(id, name, null);
            }
        }
    });

</script>