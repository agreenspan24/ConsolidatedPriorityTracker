{% extends "consolidated_tabs.html" %}

{% set modal_title = 'Add Confirmation Pass' %}
{% set modal_dropdown_label = 'Confirmation Result' %}
{% set modal_dropdown_options = ['Not Home', 'Same Day Confirmed' , 'Declined'] %}

{% include "add_shift_pass_modal.html" %}

{% block table %}
    {% if shifts %}
        <thead class="thead">
            <tr>
                <th>VanID</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Cell Phone</th>
                <th>Location</th>
                <th>Time</th>
                <th>Event</th>
                <th>Role</th>
                <th>Status</th>
                <th>New Note</th>
                <th>Add Note</th>
            </tr>
        </thead>
        <tbody class="tbody">
            {% for shift in shifts %}
            {% if shift.status in ['Scheduled', 'Invited', 'Confirmed', 'Left Msg', 'Same Day Confirmed'] %}
                <tr>
                    <td>{{shift.person}}</td>
                    <td id="name-{{shift.id}}">{{shift.volunteer.first_name + ' ' + shift.volunteer.last_name}}</td>
                    <td>{{shift.volunteer.phone_number}}</td>
                    <td>{{shift.volunteer.cellphone}}</td>
                    <td>{{shift.shift_location.locationname}}</td>
                    <td>{{shift.time.strftime('%I:%M %p')}}</td>
                    <td>{{shift.eventtype}}</td>
                    <td>{{shift.role}}</td>
                    <td>
                        <select id='status-{{shift.id}}' onchange="updateStatus({{shift.id}})" value='{{shift.status}}'>
                            <option value={{shift.status}}>{{shift.status}}</option>
                            <option value='Same Day Confirmed'>Same Day Confirmed</option>
                            <option value='In'>In</option>
                            <option value='Completed'>Completed</option>
                            <option value='Declined'>Declined</option>
                            <option value='Flake'>Flake</option>
                        </select>
                    </td>
                    <td>
                        <input id='note-{{shift.id}}' type='text'>
                    </td>
                    <td>
                        <a href="#" onclick="addNote({{shift.id}})">Add Note</a>
                    </td>
                    {% if shift.notes != 0 %}
                        {% for note in shift.notes[::-1] %}
                            <td>{{note.time.strftime('%I:%M %p')}}: {{note.text}}</td>
                        {% endfor %}
                    {% endif %}
                    <script>
                        function updateStatus(shift_id) {
                            hideAlert();

                            var statusElem = $('#status-' + shift_id);
                            var status = statusElem.val();
                            var name = $('#name-' + shift_id).html();

                            showAlert('info', 'Updating status for ' + name);
                            
                            statusElem.prop('disabled', 'disabled');

                            $.ajax({
                                type: 'POST', 
                                url: '/consolidated/{{location.locationname[0:3]}}/{{active_tab}}/pass',
                                data: {
                                    shift_id: shift_id,
                                    status: status
                                }
                            }).done(function(){
                                showAlert('success', 'Status for ' + name + ' has been updated');
                                statusElem.prop('disabled', false);
                            }).fail(function(){
                                showAlert('error', 'Status for ' + name + ' has NOT been updated');
                                statusElem.prop('disabled', false);
                            });
                        }

                        function addNote(shift_id) {
                            hideAlert();

                            var noteElem = $('#note-' + shift_id);
                            var note = noteElem.val();
                            var name = $('#name-' + shift_id).html();

                            showAlert('info', 'Adding note for ' + name);
                            noteElem.prop('disabled', 'disabled');

                            $.ajax({
                                type: 'POST', 
                                url: '/consolidated/{{shift.location.locationname[0:3]}}/{{active_tab}}/pass',
                                data: {
                                    shift_id: shift_id,
                                    note: note
                                }
                            }).done(function(){
                                showAlert('success', 'Note for ' + name + ' has been added');
                                noteElem.prop('disabled', false);
                            }).fail(function(){
                                showAlert('error', 'Note for ' + name + ' has NOT been added');
                                noteElem.prop('disabled', false);
                            });
                        }
                    </script>
                    <!-- TODO:

                        Make moving users to KPH deliberate (create another table with "walkins to kph", backend combines them)
                        Make phonenumbers editable (like, modal on the number maybe? just some way to change it)
                        Same day confirm pass #s (has been added to model)
                        Select Menu for Status: Current Status, Completed, Declined, Flaked, In, Same Day Confirmed
                        ADD PASS RESULTS (text box attached to post "called" button that logs time, automatic saved via some JS magic?) Work flow (type in note, click called) it saves and adds a new row)

                        >>> from datetime import datetime
                        >>> time = datetime.now().time()
                        >>> note = Note('kps', time, "this is a test 1", 102684833, 9)
                        >>> db.session.add(note)
                        >>> db.session.commit()
                        >>> shift = Shift.query.filter_by(id=9).first()
                        >>> print(shift)
                        <Shift 9>
                        >>> print(shift.time)
                        18:00:00
                        >>> print(shift.notes)
                        [<Note 1>]
                        >>> for note in shift.notes:
                        ...     print(note.text)
                        ...
                        this is a test 1
                    
                    -->
                </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    {% endif %}
{% endblock %}