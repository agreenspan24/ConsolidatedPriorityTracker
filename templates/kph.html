{% extends "consolidated_tabs.html" %}

{% block above_table %}
<script src="{{ url_for('static', filename='scripts/select2.js') }}" type="text/javascript"></script>
<script>
    $(document).ready(
        function () {
            $('#shift_id').select2();

            {% for group in groups %}
                $('#shift_id-{{group.id}}').val([{{group.canvass_shifts|map(attribute='id')|join(',')}}]).select2();
            {% endfor %}
        }
    );
</script>
<form action="/consolidated/{{office}}/{{active_tab}}/add_group" method="POST">
    <table class="table">
        <tbody class="tbody">
            <tr>
                <td style="min-width:300px;max-width:300px">
                    <label class="input-label" for="shift_id">Volunteers</label>
                    <select class="input-element" name="shift_id[]" id="shift_id" multiple>
                        <option></option>
                        {% for shift in shifts if (shift.status == 'In' and (shift.canvass_group == None or not shift.group.is_active)) %}
                            <option value={{shift.id}}>
                                {{shift.volunteer.first_name + ' ' + shift.volunteer.last_name + ' - ' + shift.time.strftime('%I:%M %p')}}
                            </option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <label class="input-label" for="packets_given"># Packets Given</label>
                    <input class="input-element" type="number" name="packets_given" id="packets_given" min="0" />
                </td>
                <td>
                    <label class="input-label" for="packet_names">Packets</label>
                    <input class="input-element" type="text" name="packet_names" id="packet_names" maxlength="255"/> 
                </td>

                <td>
                    <label class="input-label" for="goal">Goal</label>
                    <input class="input-element" type="number" id="goal" name="goal" min="0" />
                </td>
                <td>
                    <input class="btn btn-blue" style="margin-top:30px" type="submit" value="Create Canvass Group" />
                </td> 
            </td>
        </tbody>
    </table>
</form>

{% endblock %}

{% block table %}
    <thead class="thead">
        <tr>
            <th></th>
            <th>Name</th>
            <th>VanID</th>
            <th>Phone Number</th>
            <th>Cell</th>
            <th># Packets Out</th>
            <th>Packets</th>
            <th></th>
            <th>Time of Departure</th>
            <th>Next Check In</th>
            <th>Last Check In</th>
            <th>Check Ins</th>
            <th>Actual</th>
            <th>Goal</th>
            <th>% to Goal</th>
            <th>New Note</th>
            <th>Notes</th>
        </tr>
    </thead>
    <tbody class="tbody">
        {% if groups %}
        {% for group in groups %}
            <tr id="row-{{group.id}}" class="{{'text-green7' if group.is_returned else ('text-red7' if group.check_in_time != None and group.check_in_time < g.time_now)}}">
                <td>
                    {{loop.index}}&nbsp;&nbsp;
                    <span class="glyphicons glyphicons-remove" onclick="deleteElement({{group.id}})" style="cursor:pointer"></span>&nbsp;&nbsp;
                    <span class="glyphicons glyphicons-refresh hide" aria-hidden="true"></span>
                </td>
                <td style="vertical-align: top">
                    <select class="input-element" name="shift_id[]" id="shift_id-{{group.id}}"
                        onchange="updateElem('shift_id-{{group.id}}', 'shift_id[]', updateNames)" multiple>
                        <option></option>
                        {% for shift in group.canvass_shifts %}
                            <option value={{shift.id}}>
                                {{shift.volunteer.first_name + ' ' + shift.volunteer.last_name + ' - ' + shift.time.strftime('%I:%M %p')}}
                            </option>
                        {% endfor %}
                        {% for shift in shifts if shift.canvass_group == None and shift.status == "In" and shift.canvass_group != group.id %}
                            <option value={{shift.id}}>
                                {{shift.volunteer.first_name + ' ' + shift.volunteer.last_name + ' - ' + shift.time.strftime('%I:%M %p')}}
                            </option>
                        {% endfor %}
                    </select>
                    <span id="vol_id-{{group.id}}" class="hide">
                        {% for shift in group.canvass_shifts %}
                            <span id="vol_id-{{shift.id}}">{{shift.volunteer.id}}</span>
                        {% endfor %}
                    </span>
                    <span id="name-{{group.id}}" class="hide">
                        {% for shift in group.canvass_shifts %}
                            <span id="name-{{shift.id}}">{{shift.volunteer.first_name + ' ' + shift.volunteer.last_name}}</span>
                        {% endfor %}
                    </span>
                </td>
                <td id="vanid-{{group.id}}">
                    {% for shift in group.canvass_shifts %}
                        <p id="vanid-{{shift.id}}">{{shift.volunteer.van_id}}</p>
                    {% endfor %}
                </td>
                <td id="phone-{{group.id}}">
                    {% for shift in group.canvass_shifts %}
                        <p id="phone-{{shift.id}}">{{'({}) {}-{}'.format(shift.volunteer.phone_number[0:3], shift.volunteer.phone_number[3:6], shift.volunteer.phone_number[6:]) if shift.volunteer.phone_number else '' }}</p>
                    {% endfor %}
                </td>
                <td id="cellphone-{{group.id}}">
                    {% for shift in group.canvass_shifts %}
                        <p>
                            <input id='cell-{{shift.id}}-{{group.id}}' name="cellphone" maxlength="120" type="text" style="width:125px" value="{{shift.volunteer.cellphone if not shift.volunteer.cellphone == None}}"/>
                        </p>
                    {% endfor %}
                </td>
                <td>
                    <input id="packets_given-{{group.id}}" name="packets_given" type="number" min="0" value="{{group.packets_given if not group.packets_given == None}}" style="max-width: 50px"  />
                </td>
                <td>
                    <input id="packet_names-{{group.id}}" name="packet_names" type="text" maxlength="255" value="{{group.packet_names if not group.packet_names == None}}" />
                </td>
                <td>
                    <a id='out-{{group.id}}' name='out' onclick="updateElem('out-{{group.id}}', 'out', setOut)">
                        {{'Depart' if group.departure == None else 'Set "Not Returned"' if group.is_returned else 'Set "Returned"'}}
                    </a>
                </td>
                <td id='departure-{{group.id}}'>{{group.departure.strftime('%I:%M %p') if group.departure != None else ''}}</td>
                <td id='check_in_time-{{group.id}}'>{{group.check_in_time.strftime('%I:%M %p') if group.check_in_time != None else ''}}</td> 
                <td id='last_check_in-{{group.id}}'>{{group.last_check_in.strftime('%I:%M %p') if group.last_check_in != None else ''}}</td>
                <td id='check_ins-{{group.id}}'>{{group.check_ins}}</td>
                <td>
                    <input id="actual-{{group.id}}" name="actual" min="0" type="number" value="{{group.actual if not group.actual == None}}" style="max-width: 50px" />
                </td>
                <td>
                    <input id="goal-{{group.id}}" name="goal" min="0"  type="number" value="{{group.goal if not group.goal == None}}" style="max-width: 50px"  />
                </td>
                <td id="perc-{{group.id}}">{{((group.actual / (group.goal if group.goal != 0 else 1))*100)|round(2)|string + '%'}}</td>
                <td>
                    <input id='note-{{group.id}}' name="note" type='text' maxlength="255" placeholder="Hit Enter To Save">
                </td>
                {% if group.canvass_shifts[0].notes != 0 %}
                    {% for note in group.canvass_shifts[0].notes[::-1] %}
                        {% if note.type == 'kph' %}
                            <td id="notes-{{group.canvass_shifts[0].id}}">
                                {{note.time.strftime('%I:%M %p')}}: {{note.text}}
                                <span class="glyphicons glyphicons-remove" onclick="deleteNote({{group.canvass_shifts[0].id}}, '{{note.text}}')" style="cursor:pointer"></span>
                            </td>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </tr>
        {% endfor %}
        {% endif %}
    </tbody>
{% endblock %}

{% block footer %}
<p><a href="/consolidated/{{office}}/{{active_tab}}/backup">Click here to see past groups</a></p>
{% endblock %}


